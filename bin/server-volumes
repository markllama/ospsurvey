#!/bin/env python
from __future__ import print_function
"""
Report the storage use of all systems in a cloud
"""

from collections import namedtuple
import json
import subprocess

def get_all_projects():
  project_string = subprocess.check_output("openstack project list -f json".split())
  project_records = json.loads(project_string)
  if len(project_records) == 0:
    return []

  ProjectClass = namedtuple(
    "ProjectClass",
    [p.replace(' ', '_') for p in project_records[0].keys()]
  )
  projects = [ProjectClass._make(p.values()) for p in project_records]
  return projects
  

if __name__ == "__main__":

  projects = get_all_projects()
  servers = {}
  for project in projects:
    # servers[project['Name']] =
    servers_string = subprocess.check_output("openstack server list --project {} -f json".format(project['Name']).split())
    servers[project['Name']] = json.loads(servers_string)
    
    
  print(json.dumps(servers))
