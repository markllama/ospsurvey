#!/bin/env python
from __future__ import print_function
"""
Report the storage use of all systems in a cloud
"""

from collections import namedtuple
import json
import subprocess

def get_all_projects():
  project_string = subprocess.check_output("openstack project list -f json".split())
  project_records = json.loads(project_string)
  if len(project_records) == 0:
    return []

  ProjectClass = namedtuple(
    "ProjectClass",
    [p.replace(' ', '_') for p in project_records[0].keys()]
  )
  projects = [ProjectClass._make(p.values()) for p in project_records]
  return projects
  

if __name__ == "__main__":

  projects = get_all_projects()

  # Get detailed instance information grouped by project.
  for project in projects:
    # servers[project['Name']] =

    # get the list of servers in each project
    summary_string = subprocess.check_output("openstack server list -c Name -c ID -c Host --project {} -f json".format(project.Name).split())
    summary_list = json.loads(summary_string)

    # now get the information for each server in the project
    for summary in summary_list:
      servers = {}
      server_name = summary['Name']
      server_id = summary['ID']
      server_string = subprocess.check_output("openstack server show -f json {}".format(server_id).split())
      server = json.loads(server_string)
      servers[server_name] = server
      projects[project.Name] = servers
    
  print(json.dumps(projects))
