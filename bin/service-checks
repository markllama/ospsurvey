#!/usr/bin/env python
"""
Get the list of undercloud services.
Ensure that they are running and responding on all endpoints.
Ensure that system services are running on all controllers
"""
from __future__ import print_function

import argparse
import json
import logging
import os

import ospsurvey.version
import ospsurvey.probes.endpoints
import ospsurvey.probes.services

def parse_cli_arguments():

  parser = argparse.ArgumentParser()
  parser.add_argument("-d", "--debug", action="store_true", default=False,
                      help="Print additional information for status and diagnosis")

  parser.add_argument("-p", "--profile-dir",
                      help="Where to find OSP version profiles")
  
  env_group = parser.add_mutually_exclusive_group()
  env_group.add_argument('-V', '--require-env', dest="require_env", action='store_true', default=True)
  env_group.add_argument('--no-require-env', dest="require_env", action='store_false')
  return parser.parse_args()

def service_endpoints(services, endpoints):
  """
  Associate and return a list of services and the endpoints that provide access
  to them.
  Should also note any service without an endpoint or (is this possible?)
  endpoint without a service.
  """
  # create an empty array for each service
  endpoint_map = {s.Name:[] for s in services}
  # and put each endpoint into one
  for e in endpoints:
    endpoint_map[e.Service_Name].append(e)

  return endpoint_map

def check_credentials():
  """
  Check that the OSP credentials have been sourced into the envinronment
  OS_AUTH_URL
  OS_USERNAME
  OS_PASSWORD

  There are others, but use these as canaries
  """

  required_variables = ('OS_AUTH_URL', 'OS_USERNAME', 'OS_PASSWORD')

  logging.debug("checking openstack auth environment variables")
  ok = True
  for var in required_variables:
    if not var in os.environ:
      logging.warning("missing required environment variable: {}".format(var))
      ok = False
    else:
      logging.debug("OpenStack Auth Var: {} = {}".format(var, os.environ[var]))

  return ok


if __name__ == "__main__":

  opts = parse_cli_arguments()
  if opts.debug:
    logging.basicConfig(level=logging.DEBUG)

  version = ospsurvey.version.version()
  logging.debug("OSP version found: {}".format(version))
  
  if opts.require_env and check_credentials() is False:
    logging.fatal("Missing required environment variables: aborting survey")
    sys.exit(1)

  services = ospsurvey.probes.services.list_services()
  endpoints = ospsurvey.probes.endpoints.list_endpoints()

  # map all endpoints to a service
  se = service_endpoints(services, endpoints)

  logging.debug(se)

  # -----------------------------------------------------------------------
  # Checks
  # -----------------------------------------------------------------------
  # * all services present
  # * note extra services
  # * note any service not enabled
  # * check endpoints for each service
  # ** ping the admin interface
  # ** query the admin interface URL
  # ** ping and query all interfaces accessable from the director
  # 
